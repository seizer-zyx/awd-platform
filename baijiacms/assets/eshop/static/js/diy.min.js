
define(['jquery.ui'], function (ui) {
    var modal = {
        sysinfo: null,
        id: 0,
        type: 1,
        navs: {},
        initnav: [],
        data: {},
        selected: 'page',
        childid: null,
        keyworderr: false
    };
    jQuery.base64 = (function ($) {
        var _PADCHAR = "=", _ALPHA = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/", _VERSION = "1.2";

        function _getbyte64(s, i) {
            var idx = _ALPHA.indexOf(s.charAt(i));
            if (idx === -1) {
                throw"Cannot decode base64"
            }
            return idx
        }

        function _decode_chars(y, x) {
            while (y.length > 0) {
                var ch = y[0];
                if (ch < 0x80) {
                    y.shift();
                    x.push(String.fromCharCode(ch))
                } else if ((ch & 0x80) == 0xc0) {
                    if (y.length < 2)break;
                    ch = y.shift();
                    var ch1 = y.shift();
                    x.push(String.fromCharCode(((ch & 0x1f) << 6) + (ch1 & 0x3f)))
                } else {
                    if (y.length < 3)break;
                    ch = y.shift();
                    var ch1 = y.shift();
                    var ch2 = y.shift();
                    x.push(String.fromCharCode(((ch & 0x0f) << 12) + ((ch1 & 0x3f) << 6) + (ch2 & 0x3f)))
                }
            }
        }

        function _decode(s) {
            var pads = 0, i, b10, imax = s.length, x = [], y = [];
            s = String(s);
            if (imax === 0) {
                return s
            }
            if (imax % 4 !== 0) {
                throw"Cannot decode base64"
            }
            if (s.charAt(imax - 1) === _PADCHAR) {
                pads = 1;
                if (s.charAt(imax - 2) === _PADCHAR) {
                    pads = 2
                }
                imax -= 4
            }
            for (i = 0; i < imax; i += 4) {
                var ch1 = _getbyte64(s, i);
                var ch2 = _getbyte64(s, i + 1);
                var ch3 = _getbyte64(s, i + 2);
                var ch4 = _getbyte64(s, i + 3);
                b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12) | (_getbyte64(s, i + 2) << 6) | _getbyte64(s, i + 3);
                y.push(b10 >> 16);
                y.push((b10 >> 8) & 0xff);
                y.push(b10 & 0xff);
                _decode_chars(y, x)
            }
            switch (pads) {
                case 1:
                    b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12) | (_getbyte64(s, i + 2) << 6);
                    y.push(b10 >> 16);
                    y.push((b10 >> 8) & 0xff);
                    break;
                case 2:
                    b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12);
                    y.push(b10 >> 16);
                    break
            }
            _decode_chars(y, x);
            if (y.length > 0)throw"Cannot decode base64";
            return x.join("")
        }

        function _get_chars(ch, y) {
            if (ch < 0x80)y.push(ch); else if (ch < 0x800) {
                y.push(0xc0 + ((ch >> 6) & 0x1f));
                y.push(0x80 + (ch & 0x3f))
            } else {
                y.push(0xe0 + ((ch >> 12) & 0xf));
                y.push(0x80 + ((ch >> 6) & 0x3f));
                y.push(0x80 + (ch & 0x3f))
            }
        }

        function _encode(s) {
            if (arguments.length !== 1) {
                throw"SyntaxError: exactly one argument required"
            }
            s = String(s);
            if (s.length === 0) {
                return s
            }
            var i, b10, y = [], x = [], len = s.length;
            i = 0;
            while (i < len) {
                _get_chars(s.charCodeAt(i), y);
                while (y.length >= 3) {
                    var ch1 = y.shift();
                    var ch2 = y.shift();
                    var ch3 = y.shift();
                    b10 = (ch1 << 16) | (ch2 << 8) | ch3;
                    x.push(_ALPHA.charAt(b10 >> 18));
                    x.push(_ALPHA.charAt((b10 >> 12) & 0x3F));
                    x.push(_ALPHA.charAt((b10 >> 6) & 0x3f));
                    x.push(_ALPHA.charAt(b10 & 0x3f))
                }
                i++
            }
            switch (y.length) {
                case 1:
                    var ch = y.shift();
                    b10 = ch << 16;
                    x.push(_ALPHA.charAt(b10 >> 18) + _ALPHA.charAt((b10 >> 12) & 0x3F) + _PADCHAR + _PADCHAR);
                    break;
                case 2:
                    var ch1 = y.shift();
                    var ch2 = y.shift();
                    b10 = (ch1 << 16) | (ch2 << 8);
                    x.push(_ALPHA.charAt(b10 >> 18) + _ALPHA.charAt((b10 >> 12) & 0x3F) + _ALPHA.charAt((b10 >> 6) & 0x3f) + _PADCHAR);
                    break
            }
            return x.join("")
        }

        return {decode: _decode, encode: _encode, VERSION: _VERSION}
    }(jQuery));
    modal.init = function (params) {
        window.tpl = params.tpl;
        modal.attachurl = params.attachurl;
        modal.type = params.type;
        modal.data = params.data;
        modal.id = params.id;
        modal.diymenu = params.diymenu;
        if (modal.data) {
            modal.type = modal.data.page.type;
            modal.page = modal.data.page;
            modal.items = modal.data.items
        }
        ;
        modal.initTpl();
        modal.initPage();
        modal.initItems();
        modal.initNavs();
				 modal.initSortable();
        $(".btn-save").unbind('click').click(function () {
            var status = $(this).data('status');
            var type = $(this).data('type');
            if (status) {
                alert("正在保存，请稍候。。。");
                return
            }
              modal.save();
        });
        $("#page").unbind('click').click(function () {
            if (modal.selected == 'page') {
                return
            }
            ;
            modal.selected = 'page';
            modal.initPage()
        });
     
    }; 
    modal.initNavs = function () {
        modal.getNavs();
        var navgroup = {
            0: ['notice', 'richtext', 'banner', 'title', 'line', 'blank', 'search', 'menu', 'picture', 'picturew', 'goods'],
            1: ['diymod'],
            2: ['diymod'],
            99: []
        };
        var navpage = navgroup[modal.type];
        navpage = $.merge(navgroup[0], navpage);
        $.each(navpage, function (index, val) {
            var params = modal.navs[val];
            if (params) {
                params.id = val;
                modal.initnav.push(params)
            }
        });
        var html = tpl("tpl_navs", modal);
        $("#navs").html(html).show();
        $("#navs nav").unbind('click').click(function () {
            var id = $(this).data('id');
            if (id === 'page') {
                $("#page").trigger("click");
                return
            }
            var inArray = $.inArray(id, navpage);
            if (inArray < 0) {
                alert("此页面类型禁止添加此元素！");
                return
            }
            var item = $.extend(true, {}, modal.navs[id]);
            delete item.name;
            if (!item) {
                alert("未找到此元素！");
                return
            }
           
            var itemid = modal.getId("M", 0);
            if (item.data) {
                var itemData = $.extend(true, {}, item.data);
                var newData = {};
                var index = 0;
                $.each(itemData, function (id, data) {
                    var childid = modal.getId("C", index);
                    newData[childid] = data;
                    delete childid;
                    index++
                });
                item.data = newData
            }
            if (modal.selected && modal.selected != 'page') {
                var newItems = {};
                $.each(modal.items, function (id, eachitem) {
                    newItems[id] = eachitem;
                    if (id == modal.selected) {
                        newItems[itemid] = item
                    }
                });
                modal.items = newItems
            } else {
                modal.items[itemid] = item
            }
            ;
            modal.initItems();
            $(".drag[data-itemid='" + itemid + "']").trigger('mousedown').trigger('click');
            modal.selected = itemid
        })
    };
    modal.getId = function (S, N) {
        var date = +new Date();
        var id = S + (date + N);
        return id
    };
    modal.getNavs = function () {
        modal.navs = {
            notice: {
                name: '公告',
                params: {
                    'iconurl': window.DIYSHOP_BASE_IMAGEURL+'hotdot.jpg',
                    'noticedata': '1',
                    'speed': '4',
                    'noticenum': '5'
                },
                style: {'background': '#ffffff', 'iconcolor': '#fd5454', 'color': '#666666'},
                data: {
                    C0123456789101: {title: '这里是第一条自定义公告的标题', linkurl: '',},
                    C0123456789102: {title: '这里是第二条自定义公告的标题', linkurl: '',}
                }
            },
            banner: {
                name: '图片幻灯片',
                params: {},
                style: {
                    'dotstyle': 'rectangle',
                    'dotalign': 'left',
                    'background': '#ffffff',
                    'leftright': '5',
                    'bottom': '5',
                    'opacity': '0.8'
                },
                data: {
                    C0123456789101: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'banner-1.jpg',
                        linkurl: '',
                    },
                    C0123456789102: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'banner-2.jpg',
                        linkurl: '',
                    }
                }
            },
            richtext: {
                name: '富文本',
                params: {
                    'content': ''
                },
                style: {
                    'background': '#ffffff',
                    'padding': '0'
                }
            },
            title: {
                name: '标题栏',
                params: {
                    'title': '',
                    'icon': ''
                },
                style: {
                    'background': '#ffffff',
                    'color': '#666666',
                    'textalign': 'left',
                    'fontsize': '12',
                    'paddingtop': '5',
                    'paddingleft': '5'
                }
            },
            line: {
                name: '辅助线',
                params: {},
                style: {
                    'height': '2',
                    'background': '#ffffff',
                    "border": "#000000",
                    'padding': '10',
                    'linestyle': 'solid'
                }
            },
            blank: {name: '辅助空白', params: {}, style: {'height': '20', 'background': '#ffffff'}},
            search: {
                name: '搜索框',
                params: {'placeholder': '请输入关键字进行搜索'},
                style: {
                    'inputbackground': '#ffffff',
                    'background': '#f1f1f2',
                    'iconcolor': '#b4b4b4',
                    'color': '#999999',
                    'paddingtop': '10',
                    'paddingleft': '10',
                    'textalign': 'left',
                    'searchstyle': ''
                }
            },
            menu: {
                name: '按钮组',
                params: {},
                style: {'navstyle': '', 'background': '#ffffff', 'rownum': '4'},
                data: {
                    C0123456789101: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'icon-1.png',
                        linkurl: '',
                        text: '按钮文字1',
                        color: '#666666'
                    },
                    C0123456789102: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'icon-2.png',
                        linkurl: '',
                        text: '按钮文字2',
                        color: '#666666'
                    },
                    C0123456789103: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'icon-3.png',
                        linkurl: '',
                        text: '按钮文字3',
                        color: '#666666'
                    },
                    C0123456789104: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'icon-4.png',
                        linkurl: '',
                        text: '按钮文字4',
                        color: '#666666'
                    }
                }
            },
            picture: {
                name: '单图',
                params: {},
                style: {
                    'paddingtop': '0',
                    'paddingleft': '0'
                },
                data: {
                    C0123456789101: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'banner-1.jpg',
                        linkurl: '',
                    },
                    C0123456789102: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'banner-2.jpg',
                        linkurl: '',
                    }
                }
            },
            picturew: {
                name: '组合图片',
                params: {'row': '1'},
                style: {
                    'paddingtop': '0',
                    'paddingleft': '0'
                },
                data: {
                    C0123456789101: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'banner-1.jpg',
                        linkurl: '',
                    },
                    C0123456789102: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'banner-2.jpg',
                        linkurl: '',
                    },
                    C0123456789103: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'banner-1.jpg',
                        linkurl: '',
                    },
                    C0123456789104: {
                        imgurl: window.DIYSHOP_BASE_IMAGEURL+'banner-2.jpg',
                        linkurl: '',
                    }
                }
            },
            goods: {
                name: '商品组',
                params: {
                    'showtitle': '1',
                    'showprice': '1',
                    'goodsdata': '0',
                    'cateid': '',
                    'catename': '',
                    'groupid': '',
                    'groupname': '',
                    'goodssort': '0',
                    'goodsnum': '6',
                    'showicon': '1',
                    'iconposition': 'left top'
                },
                style: {
                    'liststyle': 'block',
                    'buystyle': 'buybtn-1',
                    'goodsicon': 'recommand',
                    'pricecolor': '#ed2822',
                    'iconpaddingtop': '0',
                    'iconpaddingleft': '0',
                    'buybtncolor': '#fe5455',
                    'iconzoom': '100',
                    'titlecolor': '#262626'
                },
                data: {
                    C0123456789101: {
                        thumb: window.DIYSHOP_BASE_IMAGEURL+'goods-1.jpg',
                        price: '20.00',
                        title: '这里是商品标题',
                        gid: ''
                    },
                    C0123456789102: {
                        thumb: window.DIYSHOP_BASE_IMAGEURL+'goods-2.jpg',
                        price: '20.00',
                        title: '这里是商品标题',
                        gid: ''
                    },
                    C0123456789103: {
                        thumb: window.DIYSHOP_BASE_IMAGEURL+'goods-3.jpg',
                        price: '20.00',
                        title: '这里是商品标题',
                        gid: ''
                    },
                    C0123456789104: {
                        thumb: window.DIYSHOP_BASE_IMAGEURL+'goods-4.jpg',
                        price: '20.00',
                        title: '这里是商品标题',
                        gid: ''
                    }
                }
            }
        }
    };
    modal.initItems = function (selected) {
        var phone = $("#phone");
        if (!modal.items) {
            modal.items = {};
            return
        }
        phone.empty();
        $.each(modal.items, function (itemid, item) {
            var newItem = $.extend(true, {}, item);
            newItem.itemid = itemid;
            var html = tpl("tpl_show_" + item.id, newItem);
            $("#phone").append(html)
        });
        var btnhtml = $("#edit-del").html();
        $("#phone .drag").append(btnhtml);
        $("#phone .drag .btn-del").unbind('click').click(function (e) {
            e.stopPropagation();
            var drag = $(this).closest(".drag");
            var itemid = drag.data('itemid');
            if(confirm("确定删除吗"))
            {
          
                delete modal.items[itemid];
                $("#page").trigger('click');
                modal.initItems();
         
          	}
        });
        if (selected) {
            modal.selectedItem(selected)
        }
    };
    modal.selectedItem = function (itemid) {
        if (!itemid) {
            return
        }
        modal.selected = itemid;
        if (itemid == 'page') {
            $("#page").trigger('click')
        } else {
            $(".drag[data-itemid='" + itemid + "']").addClass('selected')
        }
    };
    modal.initPage = function (initE) {
        if (typeof(initE) === 'undefined') {
            initE = true
        }
        if (!modal.page) {
            modal.page = {
                type: modal.type,
                title: '请输入页面标题',
                name: '未命名页面',
                desc: '',
                icon: '',
                keyword: '',
                background: '#fafafa',
                diymenu: '0',
                pagetype: '1',
            };
            if (modal.type == '99') {
                modal.page.type = '99';
                modal.page.title = '公用模块';
                modal.page.name = '未命名模块'
            }
        }
        $("#page").text(modal.page.title);
        $("#phone").css({'background-color': modal.page.background});
        $("#phone").find(".drag").removeClass("selected");
        if (initE) {
            modal.initEditor()
        }
    };
    modal.initSortable = function () {
    
        $("#phone").sortable({
            opacity: 0.8,
            placeholder: "highlight",
            items: '.drag',
            revert: 100,
            scroll: false,
            start: function (event, ui) {
                var height = ui.item.height();
                $(".highlight").css({"height": height + "px"});
                $(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>');
                $(".highlight div").css({"line-height": height - 4 + "px"})
            },
            stop: function (event, ui) {
                modal.initEditor()
            },
            update: function (event, ui) {
                modal.sortItems()
            }
        });
        $("#phone").disableSelection();
        $(document).on('mousedown', "#phone .drag", function () {
            if ($(this).hasClass("selected")) {
                return
            }
            modal.selected = $(this).data('itemid');
            $("#phone").find(".drag").removeClass("selected");
            $(this).addClass("selected");
            modal.selected = $(this).data('itemid');
            modal.initEditor()
        })
    };
    modal.sortItems = function () {
        var newItems = {};
        $("#phone .drag").each(function () {
            var thisid = $(this).data('itemid');
            newItems[thisid] = modal.items[thisid]
        });
        modal.items = newItems
    };
    modal.initEditor = function () {
        var itemid = modal.selected;
        var top = 180;
        if (modal.selected != 'page') {
            var stop = $(".selected").position().top;
            top = stop ? stop : 0
        }
        $("#diy-editor").unbind('animate').animate({"margin-top": top - 130 + "px"});
        $("body").unbind('animate').animate({scrollTop: top - 130 + "px"}, 1000);
        if (modal.selected) {
            if (modal.selected == 'page') {
                if (modal.type == 99) {
                    var html = tpl("tpl_edit_page_mod", modal.page)
                } else {
                    var html = tpl("tpl_edit_page", modal)
                }
                $("#diy-editor .inner").html(html)
            } else {
                var item = $.extend(true, {}, modal.items[modal.selected]);
                item.itemid = modal.selected;
                var html = tpl("tpl_edit_" + item.id, item);
                $("#diy-editor .inner").html(html)
            }
            $("#diy-editor").attr("data-editid", modal.selected).show()
        }
        var sliderlength = $("#diy-editor .slider").length;
        if (sliderlength > 0) {
            $("#diy-editor .slider").each(function () {
                var decimal = $(this).data('decimal');
                var multiply = $(this).data('multiply');
                var defaultValue = $(this).data("value");
                if (decimal) {
                    defaultValue = defaultValue * decimal
                }
                $(this).slider({
                    slide: function (event, ui) {
                        var sliderValue = ui.value;
                        if (decimal) {
                            sliderValue = sliderValue / decimal
                        }
                        $(this).siblings(".input").val(sliderValue).trigger("propertychange");
                        $(this).siblings(".count").find("span").text(sliderValue)
                    }, value: defaultValue, min: $(this).data("min"), max: $(this).data("max")
                })
            })
        }
        var goodsSelector = $("#diy-editor .goods-selector").length;
        if (goodsSelector > 0) {
            var _this = $("#diy-editor .goods-selector");
            _this.attr({'id': 'goods_selector', 'data-url': window.DIYSHOP_DIY_SEARCHGOODS_URL, 'data-callback': 'callbackGoods'});
            _this.unbind('click').click(function () {
         biz.selector.select({name: 'goods'});
                modal.childid = $(this).closest('.item').data('id')
            })
        }
       
        var childitems = $("#diy-editor .form-items").length;
        if (childitems > 0) {
            modal.initSortableChild();
            $("#addChild").unbind('click').click(function () {
                var itemid = modal.selected;
                var type = modal.items[itemid].id;
                var temp = modal.navs[type].data;
                var max = $(this).closest(".form-items").data('max');
                if (max) {
                    var length = modal.length(modal.items[itemid].data);
                    if (length >= max) {
                        alert("最大添加 " + max + " 个！");
                        return
                    }
                }
                var newChild = {};
                var index = 0;
                $.each(temp, function (i, t) {
                    if (index == 0) {
                        newChild = t;
                        index++
                    }
                });
                if (newChild) {
                    var childName = modal.getId("M", 0);
                    if (typeof(modal.items[itemid].data) === 'undefined') {
                        modal.items[itemid].data = {}
                    }
                    newChild = $.extend(true, {}, newChild);
                    modal.items[itemid].data[childName] = newChild
                }
                modal.initItems(itemid);
                modal.initEditor()
            });
            $("#diy-editor .form-items .item .btn-del").unbind('click').click(function () {
                var childid = $(this).closest(".item").data('id');
                var itemid = modal.selected;
                var min = $(this).closest(".form-items").data("min");
                if (min) {
                    var length = modal.length(modal.items[itemid].data);
                    if (length <= min) {
                        alert("至少保留 " + min + " 个！");
                        return
                    }
                }
                if(confirm("确定删除吗"))
                {
            
                    delete modal.items[itemid].data[childid];
                    modal.initItems(itemid);
                    modal.initEditor();
               
             	 }
            })
        }
        var richtext = $("#diy-editor .form-richtext").length;
        if (richtext > 0) {
            var ueditoroption = {
                'autoClearinitialContent': false,
                'toolbars': [['fullscreen', 'source', 'preview', '|', 'bold', 'italic', 'underline', 'strikethrough', 'forecolor', 'backcolor', '|', 'justifyleft', 'justifycenter', 'justifyright', '|', 'insertorderedlist', 'insertunorderedlist', 'blockquote', 'emotion', 'insertvideo', 'removeformat', '|', 'rowspacingtop', 'rowspacingbottom', 'lineheight', 'indent', 'paragraph', 'fontsize', '|', 'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|', 'anchor', 'map', 'print', 'drafts', '|', 'link']],
                'elementPathEnabled': false,
                'initialFrameHeight': 300,
                'focus': false,
                'maximumWords': 9999999999999
            };
            var opts = {
                type: 'image',
                direct: false,
                multi: true,
                tabs: {'upload': 'active', 'browser': '', 'crawler': ''},
                path: '',
                dest_dir: '',
                global: false,
                thumb: false,
                width: 0
            };
           
        
            if (typeof(UE) != 'undefined') {
                UE.delEditor('rich')
            }
  UE.registerUI('myinsertimage',function(editor,uiName){
				editor.registerCommand(uiName, {
					execCommand:function(){
						require(['fileUploader'], function(uploader){
							uploader.show(function(imgs){
								if (imgs.length == 0) {
									return;
								} else if (imgs.length == 1) {
									editor.execCommand('insertimage', {
										'src' : imgs[0]['url'],
										'_src' : imgs[0]['attachment'],
										'width' : '100%',
										'alt' : imgs[0].filename
									});
								} else {
									var imglist = [];
									for (i in imgs) {
										imglist.push({
											'src' : imgs[i]['url'],
											'_src' : imgs[i]['attachment'],
											'width' : '100%',
											'alt' : imgs[i].filename
										});
									}
									editor.execCommand('insertimage', imglist);
								}
							}, opts);
						});
					}
				});
				var btn = new UE.ui.Button({
					name: '插入图片',
					title: '插入图片',
					cssRules :'background-position: -726px -77px',
					onclick:function () {
						editor.execCommand(uiName);
					}
				});
				editor.addListener('selectionchange', function () {
					var state = editor.queryCommandState(uiName);
					if (state == -1) {
						btn.setDisabled(true);
						btn.setChecked(false);
					} else {
						btn.setDisabled(false);
						btn.setChecked(state);
					}
				});
				return btn;
			}, 19);
			
            var ue = UE.getEditor('rich',ueditoroption);
            ue.ready(function () {
                var thisitem = modal.items[itemid];
                var richContent = thisitem.params.content;
                richContent = $.base64.decode(richContent);
                ue.setContent(richContent);
                ue.addListener('contentChange', function () {
                    var newContent = ue.getContent();
                    newContent = $.base64.encode(newContent);
                    $("#richtext").html(newContent).trigger('change')
                })
            });
        }
        $("#diy-editor").find(".diy-bind").bind('input propertychange change', function () {
            var _this = $(this);
            var bind = _this.data("bind");
            var bindchild = _this.data('bind-child');
            var bindparent = _this.data('bind-parent');
            var initEditor = _this.data('bind-init');
            var value = '';
            var tag = this.tagName;
            if (!itemid) {
                modal.selectedItem('page ')
            }
            if (tag == 'INPUT') {
                var placeholder = _this.data('placeholder');
                value = _this.val();
                value = value == '' ? placeholder : value
            } else if (tag == 'SELECT') {
                value = _this.find('option:selected').val()
            } else if (tag == 'TEXTAREA') {
                value = _this.val()
            }
            value = $.trim(value);
            if (itemid == 'page') {
                modal.page[bind] = value;
                modal.initPage(false);
              
            } else {
                if (bindchild) {
                    if (bindparent) {
                        modal.items[itemid][bindparent][bindchild][bind] = value
                    } else {
                        modal.items[itemid][bindchild][bind] = value
                    }
                } else {
                    modal.items[itemid][bind] = value
                }
                ;
                modal.initItems(itemid);
                if (initEditor) {
                    modal.initEditor()
                }
            }
        })
    };
    modal.initSortableChild = function () {
        $("#diy-editor .inner").sortable({
            opacity: 0.8,
            placeholder: "highlight",
            items: '.item',
            revert: 100,
            scroll: false,
            cancel: '.goods-selector,input,.btn,btn-del',
            start: function (event, ui) {
                var height = ui.item.height();
                $(".highlight").css({"height": height + 22 + "px"});
                $(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>');
                $(".highlight div").css({"line-height": height + 16 + "px"})
            },
            update: function (event, ui) {
                modal.sortChildItems()
            }
        })
    };
   


    modal.initTpl = function () {
        tpl.helper("imgsrc", function (src) {
            if (typeof src != 'string') {
                return ''
            }
            if (src.indexOf('http://') == 0 || src.indexOf('https://') == 0 ) {
                return src
            } else if (src.indexOf('images/') == 0) {
                return modal.attachurl + src
            }
        });
        tpl.helper("decode", function (content) {
            return $.base64.decode(content)
        });
        tpl.helper("count", function (data) {
            return modal.length(data)
        });
        tpl.helper("toArray", function (data) {
            var oldArray = $.makeArray(data);
            var newArray = [];
            $.each(data, function (itemid, item) {
                newArray.push(item)
            });
            return newArray
        })
    };
 
    modal.sortChildItems = function () {
        var newChild = {};
        var itemid = modal.selected;
        $("#diy-editor .form-items .item").each(function () {
            var thisid = $(this).data('id');
            newChild[thisid] = modal.items[itemid].data[thisid]
        });
        modal.items[itemid].data = newChild;
        modal.initItems(itemid)
    };
    modal.length = function (json) {
        if (typeof(json) === 'undefined') {
            return 0
        }
        var jsonlen = 0;
        for (var item in json) {
            jsonlen++
        }
        return jsonlen
    };
    modal.callbackGoods = function (data) {
        if (!data) {
            alert("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        var childid = modal.childid;
        modal.items[itemid].data[childid] = {
            'title': data.title,
            'thumb': data.thumb,
            'price': data.minprice,
            'gid': data.id
        };
        modal.initItems(itemid);
        modal.initEditor();
        modal.childid = null
    };
    modal.callbackCategory = function (data) {
        if (!data) {
            alert("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        modal.items[itemid].params.catename = data.name;
        modal.items[itemid].params.cateid = data.id;
        modal.items[itemid].params.groupname = '';
        modal.items[itemid].params.groupid = '';
        modal.initItems(itemid);
        modal.initEditor()
    };
    modal.callbackGroup = function (data) {
        if (!data) {
            alert("回调数据错误，请重试！");
            return
        }
        var itemid = modal.selected;
        modal.items[itemid].params.groupname = data.name;
        modal.items[itemid].params.groupid = data.id;
        modal.items[itemid].params.catename = '';
        modal.items[itemid].params.cateid = '';
        modal.initItems(itemid);
        modal.initEditor()
    };
    modal.save = function () {
        preview = false
    
        modal.data = {};
        modal.data = {page: modal.page, items: modal.items};
        if (!modal.page.title) {
            alert("页面标题是必填项");
            $("#page").trigger("click");
            return
        }
        $(".btn-save").data('status', 1).text("保存中...");
      var posturl = window.DIYSHOP_DIY_SAVE_URL;
        $.post(posturl, {id: modal.id, data: modal.data}, function (ret) {
            if (ret.status == 1) {
                alert("保存成功！");
                location.href = window.DIYSHOP_DIY_LIST_URL;
            }else
            	{
            	alert("保存失败");
                $(".btn-save[data-type='save']").text("保存页面").data("status", 0);
                return	
            	}
         
        }, 'json')
    };
    return modal
});

